From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: ExTr1se <160177189+N1f-Angel@users.noreply.github.com>
Date: Thu, 5 Feb 2026 13:01:21 +0200
Subject: [PATCH] Pulse Optimizations: io_uring, PooledByteBuf, Mth inlining


diff --git a/net/minecraft/network/Connection.java b/net/minecraft/network/Connection.java
index 4ed9611994c5c8da01fede690197527c5b3a5731..f38564699af4dddd1172786ce886d16b77e34b44 100644
--- a/net/minecraft/network/Connection.java
+++ b/net/minecraft/network/Connection.java
@@ -5,6 +5,7 @@ import com.google.common.collect.Queues;
 import com.google.common.util.concurrent.ThreadFactoryBuilder;
 import com.mojang.logging.LogUtils;
 import io.netty.bootstrap.Bootstrap;
+import io.netty.buffer.PooledByteBufAllocator;
 import io.netty.channel.Channel;
 import io.netty.channel.ChannelException;
 import io.netty.channel.ChannelFuture;
@@ -24,6 +25,9 @@ import io.netty.channel.SimpleChannelInboundHandler;
 import io.netty.channel.epoll.Epoll;
 import io.netty.channel.epoll.EpollEventLoopGroup;
 import io.netty.channel.epoll.EpollSocketChannel;
+import io.netty.incubator.channel.uring.IOUring;
+import io.netty.incubator.channel.uring.IOUringEventLoopGroup;
+import io.netty.incubator.channel.uring.IOUringSocketChannel;
 import io.netty.channel.local.LocalChannel;
 import io.netty.channel.local.LocalServerChannel;
 import io.netty.channel.nio.NioEventLoopGroup;
@@ -79,6 +83,9 @@ public class Connection extends SimpleChannelInboundHandler<Packet<?>> {
     public static final Supplier<EpollEventLoopGroup> NETWORK_EPOLL_WORKER_GROUP = Suppliers.memoize(
         () -> new EpollEventLoopGroup(0, new ThreadFactoryBuilder().setNameFormat("Netty Epoll Client IO #%d").setDaemon(true).setUncaughtExceptionHandler(new net.minecraft.DefaultUncaughtExceptionHandlerWithName(LOGGER)).build()) // Paper
     );
+    public static final Supplier<IOUringEventLoopGroup> NETWORK_IOURING_WORKER_GROUP = Suppliers.memoize(
+        () -> new IOUringEventLoopGroup(0, new ThreadFactoryBuilder().setNameFormat("Netty io_uring Client IO #%d").setDaemon(true).setUncaughtExceptionHandler(new net.minecraft.DefaultUncaughtExceptionHandlerWithName(LOGGER)).build())
+    );
     public static final Supplier<DefaultEventLoopGroup> LOCAL_WORKER_GROUP = Suppliers.memoize(
         () -> new DefaultEventLoopGroup(0, new ThreadFactoryBuilder().setNameFormat("Netty Local Client IO #%d").setDaemon(true).setUncaughtExceptionHandler(new net.minecraft.DefaultUncaughtExceptionHandlerWithName(LOGGER)).build()) // Paper
     );
@@ -698,7 +705,7 @@ public class Connection extends SimpleChannelInboundHandler<Packet<?>> {
             eventLoopGroup = NETWORK_WORKER_GROUP.get();
         }
 
-        return new Bootstrap().group(eventLoopGroup).handler(new ChannelInitializer<Channel>() {
+        return new Bootstrap().option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT).group(eventLoopGroup).handler(new ChannelInitializer<Channel>() {
             @Override
             protected void initChannel(Channel channel) {
                 try {
@@ -761,7 +768,7 @@ public class Connection extends SimpleChannelInboundHandler<Packet<?>> {
 
     public static Connection connectToLocalServer(SocketAddress address) {
         final Connection connection = new Connection(PacketFlow.CLIENTBOUND);
-        new Bootstrap().group(LOCAL_WORKER_GROUP.get()).handler(new ChannelInitializer<Channel>() {
+        new Bootstrap().option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT).group(LOCAL_WORKER_GROUP.get()).handler(new ChannelInitializer<Channel>() {
             @Override
             protected void initChannel(Channel channel) {
                 ChannelPipeline channelPipeline = channel.pipeline();
diff --git a/net/minecraft/server/network/ServerConnectionListener.java b/net/minecraft/server/network/ServerConnectionListener.java
index bd07e6a5aa1883786d789ea71711a0c0c0a95c26..ceac63704931f996a9806f529c188458db942100 100644
--- a/net/minecraft/server/network/ServerConnectionListener.java
+++ b/net/minecraft/server/network/ServerConnectionListener.java
@@ -5,6 +5,7 @@ import com.google.common.collect.Lists;
 import com.google.common.util.concurrent.ThreadFactoryBuilder;
 import com.mojang.logging.LogUtils;
 import io.netty.bootstrap.ServerBootstrap;
+import io.netty.buffer.PooledByteBufAllocator;
 import io.netty.channel.Channel;
 import io.netty.channel.ChannelException;
 import io.netty.channel.ChannelFuture;
@@ -17,6 +18,9 @@ import io.netty.channel.EventLoopGroup;
 import io.netty.channel.epoll.Epoll;
 import io.netty.channel.epoll.EpollEventLoopGroup;
 import io.netty.channel.epoll.EpollServerSocketChannel;
+import io.netty.incubator.channel.uring.IOUring;
+import io.netty.incubator.channel.uring.IOUringEventLoopGroup;
+import io.netty.incubator.channel.uring.IOUringServerSocketChannel;
 import io.netty.channel.local.LocalAddress;
 import io.netty.channel.local.LocalServerChannel;
 import io.netty.channel.nio.NioEventLoopGroup;
@@ -54,6 +58,9 @@ public class ServerConnectionListener {
     public static final Supplier<EpollEventLoopGroup> SERVER_EPOLL_EVENT_GROUP = Suppliers.memoize(
         () -> new EpollEventLoopGroup(0, new ThreadFactoryBuilder().setNameFormat("Netty Epoll Server IO #%d").setDaemon(true).setUncaughtExceptionHandler(new net.minecraft.DefaultUncaughtExceptionHandlerWithName(LOGGER)).build()) // Paper
     );
+    public static final Supplier<IOUringEventLoopGroup> SERVER_IOURING_EVENT_GROUP = Suppliers.memoize(
+        () -> new IOUringEventLoopGroup(0, new ThreadFactoryBuilder().setNameFormat("Netty io_uring Server IO #%d").setDaemon(true).setUncaughtExceptionHandler(new net.minecraft.DefaultUncaughtExceptionHandlerWithName(LOGGER)).build())
+    );
     final MinecraftServer server;
     public volatile boolean running;
     private final List<ChannelFuture> channels = Collections.synchronizedList(Lists.newArrayList());
@@ -87,7 +94,11 @@ public class ServerConnectionListener {
         synchronized (this.channels) {
             Class<? extends io.netty.channel.ServerChannel> clazz; // Paper - Unix domain socket support
             EventLoopGroup eventLoopGroup;
-            if (Epoll.isAvailable() && this.server.isEpollEnabled()) {
+            if (dev.pulsemc.config.ConfigManager.useIoUring && IOUring.isAvailable()) {
+                clazz = IOUringServerSocketChannel.class;
+                eventLoopGroup = SERVER_IOURING_EVENT_GROUP.get();
+                LOGGER.info("Using io_uring channel type");
+            } else if (Epoll.isAvailable() && this.server.isEpollEnabled()) {
                 // Paper start - Unix domain socket support
                 if (address instanceof io.netty.channel.unix.DomainSocketAddress) {
                     clazz = io.netty.channel.epoll.EpollServerDomainSocketChannel.class;
@@ -117,6 +128,7 @@ public class ServerConnectionListener {
                 .add(
                     new ServerBootstrap()
                         .channel(clazz)
+                        .childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)
                         .childHandler(
                             new ChannelInitializer<Channel>() {
                                 @Override
@@ -200,7 +212,8 @@ public class ServerConnectionListener {
         synchronized (this.channels) {
             channelFuture = new ServerBootstrap()
                 .channel(LocalServerChannel.class)
-                .childHandler(
+                .childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)
+                        .childHandler(
                     new ChannelInitializer<Channel>() {
                         @Override
                         protected void initChannel(Channel channel) {
diff --git a/net/minecraft/util/Mth.java b/net/minecraft/util/Mth.java
index d5d8134da9423cec199cf44762460104677194d6..cabe94fca5120c9ed88a0fa03aa2c514263257da 100644
--- a/net/minecraft/util/Mth.java
+++ b/net/minecraft/util/Mth.java
@@ -77,7 +77,7 @@ public class Mth {
     }
 
     public static int abs(int value) {
-        return Math.abs(value);
+        int mask = value >> 31; return (value + mask) ^ mask;
     }
 
     public static int ceil(float value) {
@@ -91,19 +91,23 @@ public class Mth {
     }
 
     public static int clamp(int value, int min, int max) {
-        return Math.min(Math.max(value, min), max);
+        if (value < min) return min;
+        return value > max ? max : value;
     }
 
     public static long clamp(long value, long min, long max) {
-        return Math.min(Math.max(value, min), max);
+        if (value < min) return min;
+        return value > max ? max : value;
     }
 
     public static float clamp(float value, float min, float max) {
-        return value < min ? min : Math.min(value, max);
+        if (value < min) return min;
+        return value > max ? max : value;
     }
 
     public static double clamp(double value, double min, double max) {
-        return value < min ? min : Math.min(value, max);
+        if (value < min) return min;
+        return value > max ? max : value;
     }
 
     public static double clampedLerp(double start, double end, double delta) {
