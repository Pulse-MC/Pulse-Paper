From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: ExTr1se <160177189+N1f-Angel@users.noreply.github.com>
Date: Thu, 5 Feb 2026 10:56:29 +0200
Subject: [PATCH] Porting Pulse on 1.21.4


diff --git a/net/minecraft/commands/Commands.java b/net/minecraft/commands/Commands.java
index f8969a68cd352ce4fe5109205e78f5e19ab6e020..efc0b218e0ec901945ae5c19c7e5676b3197d4e0 100644
--- a/net/minecraft/commands/Commands.java
+++ b/net/minecraft/commands/Commands.java
@@ -217,6 +217,10 @@ public class Commands {
         TriggerCommand.register(this.dispatcher);
         WeatherCommand.register(this.dispatcher);
         WorldBorderCommand.register(this.dispatcher);
+
+        // Pulse start - Register new vanilla command
+        dev.pulsemc.command.PulseCommands.register(this.dispatcher);
+        // Pulse end - Register new vanilla command
         if (JvmProfiler.INSTANCE.isAvailable()) {
             JfrCommand.register(this.dispatcher);
         }
diff --git a/net/minecraft/network/protocol/game/ClientboundSectionBlocksUpdatePacket.java b/net/minecraft/network/protocol/game/ClientboundSectionBlocksUpdatePacket.java
index 10b46c59d83d1274cf491f217df2355d13b594c1..34d05debaa58b5a9d4bcb141516dee9afd23d904 100644
--- a/net/minecraft/network/protocol/game/ClientboundSectionBlocksUpdatePacket.java
+++ b/net/minecraft/network/protocol/game/ClientboundSectionBlocksUpdatePacket.java
@@ -17,8 +17,8 @@ public class ClientboundSectionBlocksUpdatePacket implements Packet<ClientGamePa
         ClientboundSectionBlocksUpdatePacket::write, ClientboundSectionBlocksUpdatePacket::new
     );
     private static final int POS_IN_SECTION_BITS = 12;
-    private final SectionPos sectionPos;
-    private final short[] positions;
+    public final SectionPos sectionPos;
+    public final short[] positions;
     private final BlockState[] states;
 
     public ClientboundSectionBlocksUpdatePacket(SectionPos sectionPos, ShortSet positions, LevelChunkSection section) {
diff --git a/net/minecraft/server/dedicated/DedicatedServer.java b/net/minecraft/server/dedicated/DedicatedServer.java
index d2db6e3a4af13984b0a790fb38e83c253914a973..19a6e73a2d83d51f156dfb2652fb65bd7abb4781 100644
--- a/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/net/minecraft/server/dedicated/DedicatedServer.java
@@ -272,6 +272,12 @@ public class DedicatedServer extends MinecraftServer implements ServerInterface
             return false;
         }
 
+        // Pulse start - Init Config and Commands
+        dev.pulsemc.config.ConfigManager.load();
+        dev.pulsemc.network.PulseMetrics.start();
+        dev.pulsemc.network.PulseBar.start();
+        // Pulse end
+
         // CraftBukkit start
         // this.setPlayerList(new DedicatedPlayerList(this, this.registries(), this.playerDataStorage)); // Spigot - moved up
         this.server.loadPlugins();
diff --git a/net/minecraft/server/network/ServerCommonPacketListenerImpl.java b/net/minecraft/server/network/ServerCommonPacketListenerImpl.java
index 218b9bd9f869a7fafabf224d6c27b6ea7192cc5e..d894a901b8970729b6d14328b90d7ca36a76c56a 100644
--- a/net/minecraft/server/network/ServerCommonPacketListenerImpl.java
+++ b/net/minecraft/server/network/ServerCommonPacketListenerImpl.java
@@ -290,27 +290,32 @@ public abstract class ServerCommonPacketListenerImpl implements ServerCommonPack
         this.send(packet, null);
     }
 
-    public void send(Packet<?> packet, @Nullable PacketSendListener listener) {
-        // CraftBukkit start
-        if (packet == null || this.processedDisconnect) { // Spigot
+    public void send(Packet<?> packet, @Nullable PacketSendListener sendListener) {
+        if (packet == null || this.processedDisconnect) return;
+
+        // PulseMC start - Smart Batching V3 (1.21.4 Fix)
+        if (this.pulseBuffer != null) {
+            // Передаем пакет в буфер. Тип слушателя теперь PacketSendListener
+            this.pulseBuffer.add(packet, sendListener);
+
+            if (packet.isTerminal()) {
+                this.pulseBuffer.flush();
+                this.close();
+            }
             return;
-        } else if (packet instanceof net.minecraft.network.protocol.game.ClientboundSetDefaultSpawnPositionPacket defaultSpawnPositionPacket) {
-            this.player.compassTarget = org.bukkit.craftbukkit.util.CraftLocation.toBukkit(defaultSpawnPositionPacket.getPos(), this.getCraftPlayer().getWorld());
         }
-        // CraftBukkit end
-        if (packet.isTerminal()) {
-            this.close();
+        // PulseMC end
+
+        if (packet instanceof net.minecraft.network.protocol.game.ClientboundSetDefaultSpawnPositionPacket p && this instanceof ServerGamePacketListenerImpl s) {
+            s.player.compassTarget = org.bukkit.craftbukkit.util.CraftLocation.toBukkit(p.getPos(), s.getPlayer().level());
         }
 
-        boolean flag = !this.suspendFlushingOnServerThread || !this.server.isSameThread();
+        if (packet.isTerminal()) this.close();
 
         try {
-            this.connection.send(packet, listener, flag);
+            this.connection.send(packet, sendListener, true);
         } catch (Throwable var7) {
-            CrashReport crashReport = CrashReport.forThrowable(var7, "Sending packet");
-            CrashReportCategory crashReportCategory = crashReport.addCategory("Packet being sent");
-            crashReportCategory.setDetail("Packet class", () -> packet.getClass().getCanonicalName());
-            throw new ReportedException(crashReport);
+            throw new net.minecraft.ReportedException(net.minecraft.CrashReport.forThrowable(var7, "Sending packet"));
         }
     }
 
diff --git a/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index a2c70d36f79b7f8560923e098e52fa7f82ca7416..ab302470b5f0521907601b8fa65e10e94be3c40d 100644
--- a/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -395,6 +395,12 @@ public class ServerGamePacketListenerImpl
             this.hasLoggedExpiry = true;
         }
         // Paper end - Prevent causing expired keys from impacting new joins
+
+        // Pulse start
+        if (this.pulseBuffer != null) {
+            this.pulseBuffer.flush();
+        }
+        // Pulse end
     }
 
     private int getMaximumFlyingTicks(Entity entity) {
