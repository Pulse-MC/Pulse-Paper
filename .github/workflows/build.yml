name: PulseMC Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    if: contains(github.event.head_commit.message, '[pulse:buildclip') || contains(github.event.head_commit.message, '[pulse:devbuild')

    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Parse Trigger & Version
        id: meta
        run: |
          MSG="${{ github.event.head_commit.message }}"
          
          MODE="none"
          VERSION="1.21.11"

          if [[ "$MSG" == *"[pulse:devbuild"* ]]; then
            MODE="devbuild"
            CUSTOM_VER=$(echo "$MSG" | sed -n 's/.*\[pulse:devbuild:\([^]]*\)\].*/\1/p')
            if [ ! -z "$CUSTOM_VER" ]; then VERSION="$CUSTOM_VER"; fi
          fi
          
          echo "Detected Mode: $MODE"
          echo "Detected Version: $VERSION"
          
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Configure Git Identity
        run: |
          git config --global user.email "builder@pulsemc.dev"
          git config --global user.name "PulseMC Builder"

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Apply Patches
        run: ./gradlew applyPatches

      - name: Build Paperclip Jar
        env:
          BUILD_NUMBER: ${{ github.run_number }}
        run: ./gradlew createMojmapPaperclipJar

      - name: Prepare Artifact
        id: prepare_file
        run: |
          echo "[PULSE] Scanning build directories..."
          JAR_FILE=$(find . -name "*paperclip*.jar" | head -n 1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "[PULSE] CRITICAL: Paperclip JAR not found!"
            exit 1
          fi
          
          PREFIX="Pulse"
          if [ "${{ steps.meta.outputs.mode }}" == "devbuild" ]; then PREFIX="PulseDev"; fi
          
          FILENAME="${PREFIX}-${{ steps.meta.outputs.version }}-b${{ github.run_number }}.jar"
          NEW_PATH="release/$FILENAME"
          
          mkdir -p release
          mv "$JAR_FILE" "$NEW_PATH"
          
          echo "[PULSE] Artifact ready: $NEW_PATH"
          
          echo "file_path=$NEW_PATH" >> $GITHUB_OUTPUT
          echo "file_name=$FILENAME" >> $GITHUB_OUTPUT

      - name: Upload to Pulse API
        if: steps.meta.outputs.mode == 'devbuild'
        env:
          API_URL: "https://api.pulsemc.dev/devbuild"
          API_TOKEN: ${{ secrets.PULSE_API_TOKEN }}
          FILE_PATH: ${{ steps.prepare_file.outputs.file_path }}
        run: |
          echo "[PULSE] Uploading DevBuild to API..."
          
          curl -X POST "$API_URL" \
            -H "Authorization: Bearer $API_TOKEN" \
            -F "version=${{ steps.meta.outputs.version }}" \
            -F "build_id=${{ github.run_number }}" \
            -F "commit_hash=${{ github.sha }}" \
            -F "author=${{ github.actor }}" \
            -F "commit_message=${{ github.event.head_commit.message }}" \
            -F "platform"=Paper" \
            -F "file=@$FILE_PATH"
          
          echo "[PULSE] Upload complete!"

      - name: Create GitHub Release
        if: steps.meta.outputs.mode == 'release'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.meta.outputs.version }}-b${{ github.run_number }}
          name: "Pulse ${{ steps.meta.outputs.version }} (Build #${{ github.run_number }})"
          body: |
            **Automated Public Release**
            
            **Version:** ${{ steps.meta.outputs.version }}
            **Changes:**
            ${{ github.event.head_commit.message }}
          files: ${{ steps.prepare_file.outputs.file_path }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
